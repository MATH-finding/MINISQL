#!/usr/bin/env python3
"""
ç´¢å¼•è§£ææµ‹è¯•æ–‡ä»¶
"""

import sys
import os

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from sql import SQLLexer, SQLParser
from sql.ast_nodes import CreateIndexStatement, DropIndexStatement


def test_lexer():
    """æµ‹è¯•è¯æ³•åˆ†æå™¨"""
    print("=== æµ‹è¯•è¯æ³•åˆ†æå™¨ ===")

    test_sqls = [
        "CREATE INDEX idx_test ON students (id)",
        "CREATE UNIQUE INDEX idx_unique ON students (name)",
        "DROP INDEX idx_test",
    ]

    for sql in test_sqls:
        print(f"\næµ‹è¯•SQL: {sql}")
        try:
            lexer = SQLLexer(sql)
            tokens = lexer.tokenize()

            print("Tokenåºåˆ—:")
            for i, token in enumerate(tokens):
                print(f"  [{i}] {token.type.name}: '{token.value}'")

        except Exception as e:
            print(f"è¯æ³•åˆ†æé”™è¯¯: {e}")


def test_parser():
    """æµ‹è¯•è¯­æ³•åˆ†æå™¨"""
    print("\n=== æµ‹è¯•è¯­æ³•åˆ†æå™¨ ===")

    test_cases = [
        {
            "sql": "CREATE INDEX idx_test ON students (id)",
            "expected": "CreateIndexStatement",
        },
        {
            "sql": "CREATE UNIQUE INDEX idx_unique ON students (name)",
            "expected": "CreateIndexStatement(unique=True)",
        },
        {"sql": "DROP INDEX idx_test", "expected": "DropIndexStatement"},
    ]

    for case in test_cases:
        sql = case["sql"]
        print(f"\næµ‹è¯•SQL: {sql}")
        print(f"æœŸæœ›ç»“æœ: {case['expected']}")

        try:
            lexer = SQLLexer(sql)
            tokens = lexer.tokenize()

            parser = SQLParser(tokens)

            # æ·»åŠ è°ƒè¯•ä¿¡æ¯
            print(
                f"è§£æå™¨å½“å‰token: {parser.current_token.type.name if parser.current_token else 'None'}"
            )

            ast = parser.parse()

            print(f"å®é™…ç»“æœ: {type(ast).__name__}")

            if isinstance(ast, CreateIndexStatement):
                print(f"  ç´¢å¼•å: {ast.index_name}")
                print(f"  è¡¨å: {ast.table_name}")
                print(f"  åˆ—å: {ast.column_name}")
                print(f"  å”¯ä¸€ç´¢å¼•: {ast.is_unique}")
            elif isinstance(ast, DropIndexStatement):
                print(f"  ç´¢å¼•å: {ast.index_name}")

            print("âœ… è§£ææˆåŠŸ")

        except Exception as e:
            print(f"âŒ è§£æé”™è¯¯: {e}")
            import traceback

            traceback.print_exc()


def test_integration():
    """æµ‹è¯•å®Œæ•´æµç¨‹"""
    print("\n=== æµ‹è¯•å®Œæ•´SQLæ‰§è¡Œæµç¨‹ ===")

    try:
        from interface.database import SimpleDatabase

        db = SimpleDatabase("test_index.db")

        # å…ˆåˆ›å»ºè¡¨
        print("\n1. åˆ›å»ºæµ‹è¯•è¡¨...")
        result = db.execute_sql(
            "CREATE TABLE test_table (id INTEGER PRIMARY KEY, name VARCHAR(50))"
        )
        print(f"åˆ›å»ºè¡¨ç»“æœ: {result}")

        # å°è¯•åˆ›å»ºç´¢å¼•
        print("\n2. åˆ›å»ºç´¢å¼•...")
        result = db.execute_sql("CREATE INDEX idx_test_id ON test_table (id)")
        print(f"åˆ›å»ºç´¢å¼•ç»“æœ: {result}")

        # å°è¯•åˆ›å»ºå”¯ä¸€ç´¢å¼•
        print("\n3. åˆ›å»ºå”¯ä¸€ç´¢å¼•...")
        result = db.execute_sql(
            "CREATE UNIQUE INDEX idx_test_name ON test_table (name)"
        )
        print(f"åˆ›å»ºå”¯ä¸€ç´¢å¼•ç»“æœ: {result}")

        # æŸ¥çœ‹ç´¢å¼•
        print("\n4. æŸ¥çœ‹ç´¢å¼•...")
        indexes = db.list_indexes("test_table")
        print(f"ç´¢å¼•åˆ—è¡¨: {indexes}")

        # åˆ é™¤ç´¢å¼•
        print("\n5. åˆ é™¤ç´¢å¼•...")
        result = db.execute_sql("DROP INDEX idx_test_id")
        print(f"åˆ é™¤ç´¢å¼•ç»“æœ: {result}")

        db.close()

        # æ¸…ç†æµ‹è¯•æ–‡ä»¶
        if os.path.exists("test_index.db"):
            os.remove("test_index.db")

    except Exception as e:
        print(f"âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: {e}")
        import traceback

        traceback.print_exc()


def main():
    print("ğŸ§ª ç´¢å¼•è§£ææµ‹è¯•å·¥å…·")
    print("=" * 40)

    test_lexer()
    test_parser()
    test_integration()

    print("\nâœ… æµ‹è¯•å®Œæˆ")


if __name__ == "__main__":
    main()
